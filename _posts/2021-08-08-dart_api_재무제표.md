---
title: 재무제표 데이터베이스 구축하기(0)
date: 2021-08-08
categories: project python 
---
## OpenDartReader 라이브러리를 활용한 재무제표 분석  
link(OpenDartReader/github)[https://github.com/FinanceData/OpenDartReader]
### 단일회사 분기별 재무제표 병합하기 
#### code
___
```python
import io
from io import BytesIO
import zipfile
import requests
import json
import xml.etree.ElementTree as ET
import pandas as pd
from tqdm import tqdm


try:
    from pandas import json_normalize
except ImportError:
    from pandas.io.json import json_normalize
```


```python
# 다중회사 주요계정 출력 함수
def finstate(api_key, corp_code, bsns_year, reprt_code):
    url = "https://opendart.fss.or.kr/api/"
    url += "fnlttMultiAcnt.json" if "," in corp_code else "fnlttSinglAcnt.json"
    
    params = {
        "crtfc_key": api_key,
        "corp_code": corp_code,
        "bsns_year":  bsns_year,   # 사업년도
        "reprt_code": reprt_code, # 1분기보고서 : "11013", 반기보고서 : "11012", 3분기보고서 : "11014", 사업보고서 : "11011"       
    }
    
    r = requests.get(url, params=params)
    jo = json.loads(r.text)
    if "list" not in jo:
        return None
    return json_normalize(jo, "list")
```


```python
# 회사 고유번호 및 회사명 출력 함수 
def corp_codes(api_key):
    url = "https://opendart.fss.or.kr/api/corpCode.xml"
    params = { "crtfc_key": api_key, }
    
    r = requests.get(url, params=params)
    
    zf = zipfile.ZipFile(io.BytesIO(r.content))
    xml_data = zf.read("CORPCODE.xml")
    
    # XML to DataFrame
    tree = ET.XML(xml_data)
    all_records = []
    
    element = tree.findall("list")
    for i, child in enumerate(element):
        record = {}
        for i, subchild in enumerate(child):
            record[subchild.tag] = subchild.text
        all_records.append(record)
    return pd.DataFrame(all_records)   
```


```python
# 단일회사 전체 재무제표 출력 함수
def finstate_all(api_key, corp_code, bsns_year, reprt_code, fs_div="CFS"):
    url = "https://opendart.fss.or.kr/api/fnlttSinglAcntAll.json"
    params = {
        "crtfc_key": api_key,
        "corp_code": corp_code,
        "bsns_year":  bsns_year,   # 사업년도
        "reprt_code": reprt_code, # 1분기보고서 : "11013", 반기보고서 : "11012", 3분기보고서 : "11014", 사업보고서 : "11011" 
        "fs_div": fs_div, # 연결재무제표: "CFS", 재무제표: "OFS"
    }
    
    r = requests.get(url, params=params)
    jo = json.loads(r.text)
    if "list" not in jo:
        return None
    return json_normalize(jo, "list")
```


```python
# XBRL 표준계정과목체계(계정과목)
def xbrl_taxonomy(api_key, sj_div='BS1'):
    url = 'https://opendart.fss.or.kr/api/xbrlTaxonomy.json'
    params = {
        'crtfc_key': api_key,
        'sj_div': sj_div, # "CFS":연결재무제표, "OFS":재무제표
    }
    r = requests.get(url, params=params)
    jo = json.loads(r.text)
    if 'list' not in jo:
        return None
    return json_normalize(jo, 'list')
```


```python
# 재무제표를 종류별로 분류하여 각각 DataFrame으로 return 해주는 함수
def finstate_classify(finstate):
    # BS : 재무상태표, IS: 손익계산서, CIS : 포괄손익계산서, CF : 현금흐름표, SCE : 자본변동표
    finstate_bs = pd.DataFrame(columns=finstate.columns)
    finstate_is = pd.DataFrame(columns=finstate.columns)
    finstate_cis = pd.DataFrame(columns=finstate.columns)
    finstate_cf = pd.DataFrame(columns=finstate.columns)
    finstate_sce = pd.DataFrame(columns=finstate.columns)
    i = 0
    for s in finstate["sj_div"]:
        if s == "BS":
            finstate_bs = finstate_bs.append(finstate.loc[i])
        elif s == "IS":
            finstate_is = finstate_is.append(finstate.loc[i])
        elif s == "CIS":
            finstate_cis = finstate_cis.append(finstate.loc[i])
        elif s == "CF":
            finstate_cf = finstate_cf.append(finstate.loc[i])
        elif s == "SCE":
            finstate_sce = finstate_sce.append(finstate.loc[i])
        i += 1
    # reset index
    finstate_bs = finstate_bs.reset_index(drop=True)
    finstate_is = finstate_is.reset_index(drop=True)
    finstate_cis = finstate_cis.reset_index(drop=True)
    finstate_cf = finstate_cf.reset_index(drop=True)
    finstate_sce = finstate_sce.reset_index(drop=True)
    
    return finstate_bs, finstate_is, finstate_cis, finstate_cf, finstate_sce
```


```python
# 상장된 (stock_code존재하는) 회사들의 corp_code 추출
key = "ef3149d745caee09f48df5004b905ec4ef3f5d7e"
corp_codes_df = corp_codes(key)
i = 0
corp_info = pd.DataFrame(columns=['corp_code', 'corp_name', 'stock_code', 'modify_date'])
for s in corp_codes_df["stock_code"]:
    if s == " ":
        i += 1
        continue
    else:
        srs = corp_codes_df.loc[i]
        corp_info = corp_info.append(srs, ignore_index=True)
        i += 1  
```


```python
# 할인율(r), 회사채 BBB- 5년 수익률
url = "https://www.kisrating.co.kr/ratingsStatistics/statics_spread.do"
resp = requests.get(url)
html = BytesIO(resp.content)
df_r = pd.read_html(html, encoding="utf-8")[0]
r = round(df_r.loc[10, "5년"] * 0.01, 4)
r
```




    0.082




```python
# IS 계정과목 
"""
영업수익(매출): "ifrs-full_Revenue" or "ifrs-full_GrossProfit"
영업이익: "dart_OperatingIncomeLoss"
법인세비용차감전순이익: "ifrs-full_ProfitLossBeforeTax"
계속영업순이익: "ifrs-full_ProfitLossFromContinuingOperations"
지배기업의 소유주에게 귀속되는 당기순이익: "ifrs-full_ProfitLossAttributableToOwnersOfParent"
기본주당이익: "ifrs-full_BasicEarningsLossPerShare"
희석주당이익: "ifrs-full_DilutedEarningsLossPerShare"
"""

# BS 계정과목
"""
자산총계: "ifrs-full_Assets"
부채총계: "ifrs-full_Liabilities"
지배기업의 소유주에게 귀속되는 자본: "ifrs-full_EquityAttributableToOwnersOfParent"
비지배지분: "ifrs-full_NoncontrollingInterests"
자본금: "ifrs-full_IssuedCapital"
보통주자본금: "dart_IssuedCapitalOfCommonStock"
우선주자본금: "dart_IssuedCapitalOfPreferredStock"
이익잉여금: "ifrs-full_RetainedEarnings"
"""
```




    '\n자산총계: "ifrs-full_Assets"\n부채총계: "ifrs-full_Liabilities"\n지배기업의 소유주에게 귀속되는 자본: "ifrs-full_EquityAttributableToOwnersOfParent"\n비지배지분: "ifrs-full_NoncontrollingInterests"\n자본금: "ifrs-full_IssuedCapital"\n보통주자본금: "dart_IssuedCapitalOfCommonStock"\n우선주자본금: "dart_IssuedCapitalOfPreferredStock"\n이익잉여금: "ifrs-full_RetainedEarnings"\n'

```python
# 1분기보고서 : "11013", 반기보고서 : "11012", 3분기보고서 : "11014", 사업보고서 : "11011"
```


```python
finstate_2020 = pd.DataFrame()
i = 0
for s in corp_info.corp_name:
    if s == "삼성전자":
        corp_code = corp_info.loc[i, "corp_code"]
        api_key = "ef3149d745caee09f48df5004b905ec4ef3f5d7e"   
        bsns_year = "2020"
        
        # 분기별 재무제표를 DataFrame에 할당
        data_01 = finstate_all(api_key, corp_code, bsns_year, "11013", fs_div="CFS")[["corp_code", "bsns_year", "sj_div", "account_id", "account_nm", "thstrm_amount"]]
        # 재무제표에서 자본변동표(SCE) 삭제
        rev_data = list(reversed(data_01.index))
        del_row = []
        for i in rev_data:
            if data_01.loc[i, "sj_div"] == "SCE":
                del_row.append(i)
        data_01 = data_01.drop(index=del_row)
        finstate_01 = pd.DataFrame(data_01, columns=["corp_code", "bsns_year", "sj_div", "account_id", "account_nm", "thstrm_amount"])
        finstate_01["thstrm_amount"] = pd.to_numeric(finstate_01.thstrm_amount, errors="coerce", downcast="float")
        
        data_02 = finstate_all(api_key, corp_code, bsns_year, "11012", fs_div="CFS")[["corp_code", "bsns_year", "sj_div", "account_id", "account_nm", "thstrm_amount"]]
        rev_data = list(reversed(data_02.index))
        del_row = []
        for i in rev_data:
            if data_02.loc[i, "sj_div"] == "SCE":
                del_row.append(i)
        data_02 = data_02.drop(index=del_row)
        finstate_02 = pd.DataFrame(data_02, columns=["corp_code", "bsns_year", "sj_div", "account_id", "account_nm", "thstrm_amount"])
        finstate_02["thstrm_amount"] = pd.to_numeric(finstate_02.thstrm_amount, errors="coerce", downcast="float")
        
        data_03 = finstate_all(api_key, corp_code, bsns_year, "11014", fs_div="CFS")[["corp_code", "bsns_year", "sj_div", "account_id", "account_nm", "thstrm_amount"]]
        rev_data = list(reversed(data_03.index))
        del_row = []
        for i in rev_data:
            if data_03.loc[i, "sj_div"] == "SCE":
                del_row.append(i)
        data_03 = data_03.drop(index=del_row)
        finstate_03 = pd.DataFrame(data_03, columns=["corp_code", "bsns_year", "sj_div", "account_id", "account_nm", "thstrm_amount"])        
        finstate_03["thstrm_amount"] = pd.to_numeric(finstate_03.thstrm_amount, errors="coerce", downcast="float")
        
        data_00 = finstate_all(api_key, corp_code, bsns_year, "11011", fs_div="CFS")[["corp_code", "bsns_year", "sj_div", "account_id", "account_nm", "thstrm_amount"]]
        rev_data = list(reversed(data_00.index))
        del_row = []
        for i in rev_data:
            if data_00.loc[i, "sj_div"] == "SCE":
                del_row.append(i)
        data_00 = data_00.drop(index=del_row)
        finstate_00 = pd.DataFrame(data_00, columns=["corp_code", "bsns_year", "sj_div", "account_id", "account_nm", "thstrm_amount"])
        finstate_00["thstrm_amount"] = pd.to_numeric(finstate_00.thstrm_amount, errors="coerce", downcast="float")
        
    i += 1
```


```python
# 1, 2, 3분기 재무제표와 사업보고서를 행으로 합치기(merge) 
finstate_2020 = finstate_01.merge(finstate_02, how="outer", on=["corp_code", "bsns_year", "sj_div", "account_id", "account_nm"], suffixes=("_01", "_02"))
finstate_2020 = finstate_2020.merge(finstate_03, how="outer", on=["corp_code", "bsns_year", "sj_div", "account_id", "account_nm"], suffixes=("", ""))
finstate_2020 = finstate_2020.merge(finstate_00, how="outer", on=["corp_code", "bsns_year", "sj_div", "account_id", "account_nm"], suffixes=("_03", "_00"))
```


```python
# scala 연산을 위해 NaN값을 0으로 변경
finstate_2020 = finstate_2020.fillna(0)
```


```python
i = 0
for s in finstate_2020.sj_div:
    if s == "BS":
        finstate_2020.loc[i, "thstrm_amount_04"] = finstate_2020.loc[i, "thstrm_amount_00"]
    else:
        finstate_2020.loc[i, "thstrm_amount_04"] = finstate_2020.loc[i, "thstrm_amount_00"] - finstate_2020.loc[i, "thstrm_amount_03"]
    i += 1
```


```python
finstate_2020.drop(columns="thstrm_amount_00")
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>corp_code</th>
      <th>bsns_year</th>
      <th>sj_div</th>
      <th>account_id</th>
      <th>account_nm</th>
      <th>thstrm_amount_01</th>
      <th>thstrm_amount_02</th>
      <th>thstrm_amount_03</th>
      <th>thstrm_amount_04</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>00126380</td>
      <td>2020</td>
      <td>BS</td>
      <td>ifrs-full_CurrentAssets</td>
      <td>유동자산</td>
      <td>1.867397e+14</td>
      <td>1.861369e+14</td>
      <td>2.036349e+14</td>
      <td>1.982156e+14</td>
    </tr>
    <tr>
      <th>1</th>
      <td>00126380</td>
      <td>2020</td>
      <td>BS</td>
      <td>ifrs-full_CashAndCashEquivalents</td>
      <td>현금및현금성자산</td>
      <td>2.791668e+13</td>
      <td>3.610961e+13</td>
      <td>2.656610e+13</td>
      <td>2.938258e+13</td>
    </tr>
    <tr>
      <th>2</th>
      <td>00126380</td>
      <td>2020</td>
      <td>BS</td>
      <td>dart_ShortTermDepositsNotClassifiedAsCashEquiv...</td>
      <td>단기금융상품</td>
      <td>7.863802e+13</td>
      <td>7.512761e+13</td>
      <td>8.969403e+13</td>
      <td>9.244171e+13</td>
    </tr>
    <tr>
      <th>3</th>
      <td>00126380</td>
      <td>2020</td>
      <td>BS</td>
      <td>-표준계정코드 미사용-</td>
      <td>단기상각후원가금융자산</td>
      <td>3.037379e+12</td>
      <td>1.224565e+12</td>
      <td>1.684068e+12</td>
      <td>2.757111e+12</td>
    </tr>
    <tr>
      <th>4</th>
      <td>00126380</td>
      <td>2020</td>
      <td>BS</td>
      <td>ifrs-full_CurrentFinancialAssetsAtFairValueThr...</td>
      <td>단기당기손익-공정가치금융자산</td>
      <td>1.238759e+12</td>
      <td>5.826410e+11</td>
      <td>5.961220e+11</td>
      <td>7.145100e+10</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>124</th>
      <td>00126380</td>
      <td>2020</td>
      <td>CF</td>
      <td>dart_RepaymentsOfLongTermBorrowings</td>
      <td>사채 및 장기차입금의 상환</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>6.727550e+11</td>
      <td>1.921920e+11</td>
    </tr>
    <tr>
      <th>125</th>
      <td>00126380</td>
      <td>2020</td>
      <td>CF</td>
      <td>-표준계정코드 미사용-</td>
      <td>매각예정분류</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>-4.471000e+10</td>
      <td>4.457100e+10</td>
    </tr>
    <tr>
      <th>126</th>
      <td>00126380</td>
      <td>2020</td>
      <td>BS</td>
      <td>-표준계정코드 미사용-</td>
      <td>상각후원가금융자산</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
    </tr>
    <tr>
      <th>127</th>
      <td>00126380</td>
      <td>2020</td>
      <td>CF</td>
      <td>dart_AcquisitionOfTreasuryShares</td>
      <td>자기주식의 취득</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
    </tr>
    <tr>
      <th>128</th>
      <td>00126380</td>
      <td>2020</td>
      <td>CF</td>
      <td>-표준계정코드 미사용-</td>
      <td>장기차입금의 차입</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>1.449500e+10</td>
    </tr>
  </tbody>
</table>
<p>129 rows × 9 columns</p>
</div>


